# Результаты домашнего задания "08.02 Работа с Playbook"

1. Приготовьте свой собственный inventory файл `prod.yml`.

    - ```yaml
        ---
        clickhouse:
          hosts:
            localhost:
              ansible_connection: local
      ```

2. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает [vector](https://vector.dev).
3. При создании tasks рекомендую использовать модули: `get_url`, `template`, `unarchive`, `file`.
4. Tasks должны: скачать нужной версии дистрибутив, выполнить распаковку в выбранную директорию, установить vector.

    - ```bash

        - name: Install vector
          hosts: clickhouse
          handlers:
              - name: Start vector service
              become: true
              ansible.builtin.service:
                  name: vector
                  state: started
          tasks:
              - name: Download script Vector repo
                ansible.builtin.get_url:
                  url: "https://repositories.timber.io/public/vector/cfg/setup/bash.deb.sh"
                  dest: "./bash.deb.sh"
                  mode: "0755"
              - name: Run script for add specified repository into sources list
                become: true
                ansible.builtin.script: "./bash.deb.sh"
              - name: Install Vector
                become: true
                ansible.builtin.apt:
                  name: vector
                  update_cache: true
              notify: Start vector service

      ```

5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

    - ```bash
       
        vagrant@vagrant:~/playbooks$ ansible-lint --version        
        ansible-lint 6.0.2 using ansible 2.12.5

        vagrant@vagrant:~/playbooks$ ansible-lint site.yml

      ```

6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

    - ```bash

        vagrant@vagrant:~/playbooks$ ansible-playbook -i inventory/prod.yml site.yml --check

        PLAY [Install Clickhouse] ***************************************************************************************************************************************************************************************

        TASK [Gathering Facts] ******************************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Install transport-https ca-certificates dirmngr] **********************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add an apt key by id from a keyserver] ********************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add specified repository into sources list] ***************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Install clickhouse packages] ******************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Create database] ******************************************************************************************************************************************************************************************
        skipping: [localhost]

        PLAY [Install vector] *******************************************************************************************************************************************************************************************

        TASK [Gathering Facts] ******************************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add the Vector repo] **************************************************************************************************************************************************************************************
        changed: [localhost]

        TASK [Run script for add specified repository into sources list] ************************************************************************************************************************************************
        skipping: [localhost]

        TASK [Install Vector] *******************************************************************************************************************************************************************************************
        ok: [localhost]

        PLAY RECAP ******************************************************************************************************************************************************************************************************
        localhost                  : ok=8    changed=1    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0

      ```

7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.

    - ```bash

        vagrant@vagrant:~/playbooks$ ansible-playbook -i inventory/prod.yml site.yml --diff

        PLAY [Install Clickhouse] ***************************************************************************************************************************************************************************************

        TASK [Gathering Facts] ******************************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Install transport-https ca-certificates dirmngr] **********************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add an apt key by id from a keyserver] ********************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add specified repository into sources list] ***************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Install clickhouse packages] ******************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Create database] ******************************************************************************************************************************************************************************************
        ok: [localhost]

        PLAY [Install vector] *******************************************************************************************************************************************************************************************

        TASK [Gathering Facts] ******************************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Add the Vector repo] **************************************************************************************************************************************************************************************
        ok: [localhost]

        TASK [Run script for add specified repository into sources list] ************************************************************************************************************************************************
        changed: [localhost]

        TASK [Install Vector] *******************************************************************************************************************************************************************************************
        ok: [localhost]

        PLAY RECAP ******************************************************************************************************************************************************************************************************
        localhost                  : ok=10   changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

      ```

8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.
    - `playbook` идемпотентен
9. Подготовьте README.md файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.
10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-02-playbook` на фиксирующий коммит, в ответ предоставьте ссылку на него.
    - Ссылка на `playbook`: <https://github.com/prunovr/devops-netology/tree/main/ansible/playbooks>
